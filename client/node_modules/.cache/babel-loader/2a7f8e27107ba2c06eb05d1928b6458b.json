{"ast":null,"code":"\"use strict\";\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nvar Logger = require('./Logger');\n\nvar SIPMessage = require('./SIPMessage');\n\nvar JsSIP_C = require('./Constants');\n\nvar Transactions = require('./Transactions');\n\nvar Dialog_RequestSender = require('./Dialog/RequestSender');\n\nvar Utils = require('./Utils');\n\nvar logger = new Logger('Dialog');\nvar C = {\n  // Dialog states.\n  STATUS_EARLY: 1,\n  STATUS_CONFIRMED: 2\n}; // RFC 3261 12.1.\n\nmodule.exports = /*#__PURE__*/function () {\n  _createClass(Dialog, null, [{\n    key: \"C\",\n    // Expose C object.\n    get: function get() {\n      return C;\n    }\n  }]);\n\n  function Dialog(owner, message, type) {\n    var state = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : C.STATUS_CONFIRMED;\n\n    _classCallCheck(this, Dialog);\n\n    this._owner = owner;\n    this._ua = owner._ua;\n    this._uac_pending_reply = false;\n    this._uas_pending_reply = false;\n\n    if (!message.hasHeader('contact')) {\n      return {\n        error: 'unable to create a Dialog without Contact header field'\n      };\n    }\n\n    if (message instanceof SIPMessage.IncomingResponse) {\n      state = message.status_code < 200 ? C.STATUS_EARLY : C.STATUS_CONFIRMED;\n    }\n\n    var contact = message.parseHeader('contact'); // RFC 3261 12.1.1.\n\n    if (type === 'UAS') {\n      this._id = {\n        call_id: message.call_id,\n        local_tag: message.to_tag,\n        remote_tag: message.from_tag,\n        toString: function toString() {\n          return this.call_id + this.local_tag + this.remote_tag;\n        }\n      };\n      this._state = state;\n      this._remote_seqnum = message.cseq;\n      this._local_uri = message.parseHeader('to').uri;\n      this._remote_uri = message.parseHeader('from').uri;\n      this._remote_target = contact.uri;\n      this._route_set = message.getHeaders('record-route');\n      this._ack_seqnum = this._remote_seqnum;\n    } // RFC 3261 12.1.2.\n    else if (type === 'UAC') {\n        this._id = {\n          call_id: message.call_id,\n          local_tag: message.from_tag,\n          remote_tag: message.to_tag,\n          toString: function toString() {\n            return this.call_id + this.local_tag + this.remote_tag;\n          }\n        };\n        this._state = state;\n        this._local_seqnum = message.cseq;\n        this._local_uri = message.parseHeader('from').uri;\n        this._remote_uri = message.parseHeader('to').uri;\n        this._remote_target = contact.uri;\n        this._route_set = message.getHeaders('record-route').reverse();\n        this._ack_seqnum = null;\n      }\n\n    this._ua.newDialog(this);\n\n    logger.debug(\"new \".concat(type, \" dialog created with status \").concat(this._state === C.STATUS_EARLY ? 'EARLY' : 'CONFIRMED'));\n  }\n\n  _createClass(Dialog, [{\n    key: \"update\",\n    value: function update(message, type) {\n      this._state = C.STATUS_CONFIRMED;\n      logger.debug(\"dialog \".concat(this._id.toString(), \"  changed to CONFIRMED state\"));\n\n      if (type === 'UAC') {\n        // RFC 3261 13.2.2.4.\n        this._route_set = message.getHeaders('record-route').reverse();\n      }\n    }\n  }, {\n    key: \"terminate\",\n    value: function terminate() {\n      logger.debug(\"dialog \".concat(this._id.toString(), \" deleted\"));\n\n      this._ua.destroyDialog(this);\n    }\n  }, {\n    key: \"sendRequest\",\n    value: function sendRequest(method) {\n      var _this = this;\n\n      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n      var extraHeaders = Utils.cloneArray(options.extraHeaders);\n      var eventHandlers = Utils.cloneObject(options.eventHandlers);\n      var body = options.body || null;\n\n      var request = this._createRequest(method, extraHeaders, body); // Increase the local CSeq on authentication.\n\n\n      eventHandlers.onAuthenticated = function () {\n        _this._local_seqnum += 1;\n      };\n\n      var request_sender = new Dialog_RequestSender(this, request, eventHandlers);\n      request_sender.send(); // Return the instance of OutgoingRequest.\n\n      return request;\n    }\n  }, {\n    key: \"receiveRequest\",\n    value: function receiveRequest(request) {\n      // Check in-dialog request.\n      if (!this._checkInDialogRequest(request)) {\n        return;\n      } // ACK received. Cleanup this._ack_seqnum.\n\n\n      if (request.method === JsSIP_C.ACK && this._ack_seqnum !== null) {\n        this._ack_seqnum = null;\n      } // INVITE received. Set this._ack_seqnum.\n      else if (request.method === JsSIP_C.INVITE) {\n          this._ack_seqnum = request.cseq;\n        }\n\n      this._owner.receiveRequest(request);\n    } // RFC 3261 12.2.1.1.\n\n  }, {\n    key: \"_createRequest\",\n    value: function _createRequest(method, extraHeaders, body) {\n      extraHeaders = Utils.cloneArray(extraHeaders);\n\n      if (!this._local_seqnum) {\n        this._local_seqnum = Math.floor(Math.random() * 10000);\n      }\n\n      var cseq = method === JsSIP_C.CANCEL || method === JsSIP_C.ACK ? this._local_seqnum : this._local_seqnum += 1;\n      var request = new SIPMessage.OutgoingRequest(method, this._remote_target, this._ua, {\n        'cseq': cseq,\n        'call_id': this._id.call_id,\n        'from_uri': this._local_uri,\n        'from_tag': this._id.local_tag,\n        'to_uri': this._remote_uri,\n        'to_tag': this._id.remote_tag,\n        'route_set': this._route_set\n      }, extraHeaders, body);\n      return request;\n    } // RFC 3261 12.2.2.\n\n  }, {\n    key: \"_checkInDialogRequest\",\n    value: function _checkInDialogRequest(request) {\n      var _this2 = this;\n\n      if (!this._remote_seqnum) {\n        this._remote_seqnum = request.cseq;\n      } else if (request.cseq < this._remote_seqnum) {\n        if (request.method === JsSIP_C.ACK) {\n          // We are not expecting any ACK with lower seqnum than the current one.\n          // Or this is not the ACK we are waiting for.\n          if (this._ack_seqnum === null || request.cseq !== this._ack_seqnum) {\n            return false;\n          }\n        } else {\n          request.reply(500);\n          return false;\n        }\n      } else if (request.cseq > this._remote_seqnum) {\n        this._remote_seqnum = request.cseq;\n      } // RFC3261 14.2 Modifying an Existing Session -UAS BEHAVIOR-.\n\n\n      if (request.method === JsSIP_C.INVITE || request.method === JsSIP_C.UPDATE && request.body) {\n        if (this._uac_pending_reply === true) {\n          request.reply(491);\n        } else if (this._uas_pending_reply === true) {\n          var retryAfter = (Math.random() * 10 | 0) + 1;\n          request.reply(500, null, [\"Retry-After:\".concat(retryAfter)]);\n          return false;\n        } else {\n          this._uas_pending_reply = true;\n\n          var stateChanged = function stateChanged() {\n            if (request.server_transaction.state === Transactions.C.STATUS_ACCEPTED || request.server_transaction.state === Transactions.C.STATUS_COMPLETED || request.server_transaction.state === Transactions.C.STATUS_TERMINATED) {\n              request.server_transaction.removeListener('stateChanged', stateChanged);\n              _this2._uas_pending_reply = false;\n            }\n          };\n\n          request.server_transaction.on('stateChanged', stateChanged);\n        } // RFC3261 12.2.2 Replace the dialog`s remote target URI if the request is accepted.\n\n\n        if (request.hasHeader('contact')) {\n          request.server_transaction.on('stateChanged', function () {\n            if (request.server_transaction.state === Transactions.C.STATUS_ACCEPTED) {\n              _this2._remote_target = request.parseHeader('contact').uri;\n            }\n          });\n        }\n      } else if (request.method === JsSIP_C.NOTIFY) {\n        // RFC6665 3.2 Replace the dialog`s remote target URI if the request is accepted.\n        if (request.hasHeader('contact')) {\n          request.server_transaction.on('stateChanged', function () {\n            if (request.server_transaction.state === Transactions.C.STATUS_COMPLETED) {\n              _this2._remote_target = request.parseHeader('contact').uri;\n            }\n          });\n        }\n      }\n\n      return true;\n    }\n  }, {\n    key: \"id\",\n    get: function get() {\n      return this._id;\n    }\n  }, {\n    key: \"local_seqnum\",\n    get: function get() {\n      return this._local_seqnum;\n    },\n    set: function set(num) {\n      this._local_seqnum = num;\n    }\n  }, {\n    key: \"owner\",\n    get: function get() {\n      return this._owner;\n    }\n  }, {\n    key: \"uac_pending_reply\",\n    get: function get() {\n      return this._uac_pending_reply;\n    },\n    set: function set(pending) {\n      this._uac_pending_reply = pending;\n    }\n  }, {\n    key: \"uas_pending_reply\",\n    get: function get() {\n      return this._uas_pending_reply;\n    }\n  }]);\n\n  return Dialog;\n}();","map":{"version":3,"sources":["/Users/tuphan/Desktop/ubuntuGcalls/client/node_modules/jssip/lib-es5/Dialog.js"],"names":["_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_createClass","protoProps","staticProps","prototype","Logger","require","SIPMessage","JsSIP_C","Transactions","Dialog_RequestSender","Utils","logger","C","STATUS_EARLY","STATUS_CONFIRMED","module","exports","Dialog","get","owner","message","type","state","arguments","undefined","_owner","_ua","_uac_pending_reply","_uas_pending_reply","hasHeader","error","IncomingResponse","status_code","contact","parseHeader","_id","call_id","local_tag","to_tag","remote_tag","from_tag","toString","_state","_remote_seqnum","cseq","_local_uri","uri","_remote_uri","_remote_target","_route_set","getHeaders","_ack_seqnum","_local_seqnum","reverse","newDialog","debug","concat","value","update","terminate","destroyDialog","sendRequest","method","_this","options","extraHeaders","cloneArray","eventHandlers","cloneObject","body","request","_createRequest","onAuthenticated","request_sender","send","receiveRequest","_checkInDialogRequest","ACK","INVITE","Math","floor","random","CANCEL","OutgoingRequest","_this2","reply","UPDATE","retryAfter","stateChanged","server_transaction","STATUS_ACCEPTED","STATUS_COMPLETED","STATUS_TERMINATED","removeListener","on","NOTIFY","set","num","pending"],"mappings":"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","sourcesContent":["\"use strict\";\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\nvar Logger = require('./Logger');\n\nvar SIPMessage = require('./SIPMessage');\n\nvar JsSIP_C = require('./Constants');\n\nvar Transactions = require('./Transactions');\n\nvar Dialog_RequestSender = require('./Dialog/RequestSender');\n\nvar Utils = require('./Utils');\n\nvar logger = new Logger('Dialog');\nvar C = {\n  // Dialog states.\n  STATUS_EARLY: 1,\n  STATUS_CONFIRMED: 2\n}; // RFC 3261 12.1.\n\nmodule.exports = /*#__PURE__*/function () {\n  _createClass(Dialog, null, [{\n    key: \"C\",\n    // Expose C object.\n    get: function get() {\n      return C;\n    }\n  }]);\n\n  function Dialog(owner, message, type) {\n    var state = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : C.STATUS_CONFIRMED;\n\n    _classCallCheck(this, Dialog);\n\n    this._owner = owner;\n    this._ua = owner._ua;\n    this._uac_pending_reply = false;\n    this._uas_pending_reply = false;\n\n    if (!message.hasHeader('contact')) {\n      return {\n        error: 'unable to create a Dialog without Contact header field'\n      };\n    }\n\n    if (message instanceof SIPMessage.IncomingResponse) {\n      state = message.status_code < 200 ? C.STATUS_EARLY : C.STATUS_CONFIRMED;\n    }\n\n    var contact = message.parseHeader('contact'); // RFC 3261 12.1.1.\n\n    if (type === 'UAS') {\n      this._id = {\n        call_id: message.call_id,\n        local_tag: message.to_tag,\n        remote_tag: message.from_tag,\n        toString: function toString() {\n          return this.call_id + this.local_tag + this.remote_tag;\n        }\n      };\n      this._state = state;\n      this._remote_seqnum = message.cseq;\n      this._local_uri = message.parseHeader('to').uri;\n      this._remote_uri = message.parseHeader('from').uri;\n      this._remote_target = contact.uri;\n      this._route_set = message.getHeaders('record-route');\n      this._ack_seqnum = this._remote_seqnum;\n    } // RFC 3261 12.1.2.\n    else if (type === 'UAC') {\n        this._id = {\n          call_id: message.call_id,\n          local_tag: message.from_tag,\n          remote_tag: message.to_tag,\n          toString: function toString() {\n            return this.call_id + this.local_tag + this.remote_tag;\n          }\n        };\n        this._state = state;\n        this._local_seqnum = message.cseq;\n        this._local_uri = message.parseHeader('from').uri;\n        this._remote_uri = message.parseHeader('to').uri;\n        this._remote_target = contact.uri;\n        this._route_set = message.getHeaders('record-route').reverse();\n        this._ack_seqnum = null;\n      }\n\n    this._ua.newDialog(this);\n\n    logger.debug(\"new \".concat(type, \" dialog created with status \").concat(this._state === C.STATUS_EARLY ? 'EARLY' : 'CONFIRMED'));\n  }\n\n  _createClass(Dialog, [{\n    key: \"update\",\n    value: function update(message, type) {\n      this._state = C.STATUS_CONFIRMED;\n      logger.debug(\"dialog \".concat(this._id.toString(), \"  changed to CONFIRMED state\"));\n\n      if (type === 'UAC') {\n        // RFC 3261 13.2.2.4.\n        this._route_set = message.getHeaders('record-route').reverse();\n      }\n    }\n  }, {\n    key: \"terminate\",\n    value: function terminate() {\n      logger.debug(\"dialog \".concat(this._id.toString(), \" deleted\"));\n\n      this._ua.destroyDialog(this);\n    }\n  }, {\n    key: \"sendRequest\",\n    value: function sendRequest(method) {\n      var _this = this;\n\n      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n      var extraHeaders = Utils.cloneArray(options.extraHeaders);\n      var eventHandlers = Utils.cloneObject(options.eventHandlers);\n      var body = options.body || null;\n\n      var request = this._createRequest(method, extraHeaders, body); // Increase the local CSeq on authentication.\n\n\n      eventHandlers.onAuthenticated = function () {\n        _this._local_seqnum += 1;\n      };\n\n      var request_sender = new Dialog_RequestSender(this, request, eventHandlers);\n      request_sender.send(); // Return the instance of OutgoingRequest.\n\n      return request;\n    }\n  }, {\n    key: \"receiveRequest\",\n    value: function receiveRequest(request) {\n      // Check in-dialog request.\n      if (!this._checkInDialogRequest(request)) {\n        return;\n      } // ACK received. Cleanup this._ack_seqnum.\n\n\n      if (request.method === JsSIP_C.ACK && this._ack_seqnum !== null) {\n        this._ack_seqnum = null;\n      } // INVITE received. Set this._ack_seqnum.\n      else if (request.method === JsSIP_C.INVITE) {\n          this._ack_seqnum = request.cseq;\n        }\n\n      this._owner.receiveRequest(request);\n    } // RFC 3261 12.2.1.1.\n\n  }, {\n    key: \"_createRequest\",\n    value: function _createRequest(method, extraHeaders, body) {\n      extraHeaders = Utils.cloneArray(extraHeaders);\n\n      if (!this._local_seqnum) {\n        this._local_seqnum = Math.floor(Math.random() * 10000);\n      }\n\n      var cseq = method === JsSIP_C.CANCEL || method === JsSIP_C.ACK ? this._local_seqnum : this._local_seqnum += 1;\n      var request = new SIPMessage.OutgoingRequest(method, this._remote_target, this._ua, {\n        'cseq': cseq,\n        'call_id': this._id.call_id,\n        'from_uri': this._local_uri,\n        'from_tag': this._id.local_tag,\n        'to_uri': this._remote_uri,\n        'to_tag': this._id.remote_tag,\n        'route_set': this._route_set\n      }, extraHeaders, body);\n      return request;\n    } // RFC 3261 12.2.2.\n\n  }, {\n    key: \"_checkInDialogRequest\",\n    value: function _checkInDialogRequest(request) {\n      var _this2 = this;\n\n      if (!this._remote_seqnum) {\n        this._remote_seqnum = request.cseq;\n      } else if (request.cseq < this._remote_seqnum) {\n        if (request.method === JsSIP_C.ACK) {\n          // We are not expecting any ACK with lower seqnum than the current one.\n          // Or this is not the ACK we are waiting for.\n          if (this._ack_seqnum === null || request.cseq !== this._ack_seqnum) {\n            return false;\n          }\n        } else {\n          request.reply(500);\n          return false;\n        }\n      } else if (request.cseq > this._remote_seqnum) {\n        this._remote_seqnum = request.cseq;\n      } // RFC3261 14.2 Modifying an Existing Session -UAS BEHAVIOR-.\n\n\n      if (request.method === JsSIP_C.INVITE || request.method === JsSIP_C.UPDATE && request.body) {\n        if (this._uac_pending_reply === true) {\n          request.reply(491);\n        } else if (this._uas_pending_reply === true) {\n          var retryAfter = (Math.random() * 10 | 0) + 1;\n          request.reply(500, null, [\"Retry-After:\".concat(retryAfter)]);\n          return false;\n        } else {\n          this._uas_pending_reply = true;\n\n          var stateChanged = function stateChanged() {\n            if (request.server_transaction.state === Transactions.C.STATUS_ACCEPTED || request.server_transaction.state === Transactions.C.STATUS_COMPLETED || request.server_transaction.state === Transactions.C.STATUS_TERMINATED) {\n              request.server_transaction.removeListener('stateChanged', stateChanged);\n              _this2._uas_pending_reply = false;\n            }\n          };\n\n          request.server_transaction.on('stateChanged', stateChanged);\n        } // RFC3261 12.2.2 Replace the dialog`s remote target URI if the request is accepted.\n\n\n        if (request.hasHeader('contact')) {\n          request.server_transaction.on('stateChanged', function () {\n            if (request.server_transaction.state === Transactions.C.STATUS_ACCEPTED) {\n              _this2._remote_target = request.parseHeader('contact').uri;\n            }\n          });\n        }\n      } else if (request.method === JsSIP_C.NOTIFY) {\n        // RFC6665 3.2 Replace the dialog`s remote target URI if the request is accepted.\n        if (request.hasHeader('contact')) {\n          request.server_transaction.on('stateChanged', function () {\n            if (request.server_transaction.state === Transactions.C.STATUS_COMPLETED) {\n              _this2._remote_target = request.parseHeader('contact').uri;\n            }\n          });\n        }\n      }\n\n      return true;\n    }\n  }, {\n    key: \"id\",\n    get: function get() {\n      return this._id;\n    }\n  }, {\n    key: \"local_seqnum\",\n    get: function get() {\n      return this._local_seqnum;\n    },\n    set: function set(num) {\n      this._local_seqnum = num;\n    }\n  }, {\n    key: \"owner\",\n    get: function get() {\n      return this._owner;\n    }\n  }, {\n    key: \"uac_pending_reply\",\n    get: function get() {\n      return this._uac_pending_reply;\n    },\n    set: function set(pending) {\n      this._uac_pending_reply = pending;\n    }\n  }, {\n    key: \"uas_pending_reply\",\n    get: function get() {\n      return this._uas_pending_reply;\n    }\n  }]);\n\n  return Dialog;\n}();"]},"metadata":{},"sourceType":"script"}