{"ast":null,"code":"\"use strict\";\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) {\n  var it;\n\n  if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) {\n    if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") {\n      if (it) o = it;\n      var i = 0;\n\n      var F = function F() {};\n\n      return {\n        s: F,\n        n: function n() {\n          if (i >= o.length) return {\n            done: true\n          };\n          return {\n            done: false,\n            value: o[i++]\n          };\n        },\n        e: function e(_e) {\n          throw _e;\n        },\n        f: F\n      };\n    }\n\n    throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n  }\n\n  var normalCompletion = true,\n      didErr = false,\n      err;\n  return {\n    s: function s() {\n      it = o[Symbol.iterator]();\n    },\n    n: function n() {\n      var step = it.next();\n      normalCompletion = step.done;\n      return step;\n    },\n    e: function e(_e2) {\n      didErr = true;\n      err = _e2;\n    },\n    f: function f() {\n      try {\n        if (!normalCompletion && it[\"return\"] != null) it[\"return\"]();\n      } finally {\n        if (didErr) throw err;\n      }\n    }\n  };\n}\n\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\n\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}\n\nvar Logger = require('./Logger');\n\nvar JsSIP_C = require('./Constants');\n\nvar SIPMessage = require('./SIPMessage');\n\nvar Utils = require('./Utils');\n\nvar logger = new Logger('sanityCheck'); // Checks for requests and responses.\n\nvar all = [minimumHeaders]; // Checks for requests.\n\nvar requests = [rfc3261_8_2_2_1, rfc3261_16_3_4, rfc3261_18_3_request, rfc3261_8_2_2_2]; // Checks for responses.\n\nvar responses = [rfc3261_8_1_3_3, rfc3261_18_3_response]; // local variables.\n\nvar message;\nvar ua;\nvar transport;\n\nmodule.exports = function (m, u, t) {\n  message = m;\n  ua = u;\n  transport = t;\n\n  var _iterator = _createForOfIteratorHelper(all),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var _check2 = _step.value;\n\n      if (_check2() === false) {\n        return false;\n      }\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  if (message instanceof SIPMessage.IncomingRequest) {\n    var _iterator2 = _createForOfIteratorHelper(requests),\n        _step2;\n\n    try {\n      for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n        var check = _step2.value;\n\n        if (check() === false) {\n          return false;\n        }\n      }\n    } catch (err) {\n      _iterator2.e(err);\n    } finally {\n      _iterator2.f();\n    }\n  } else if (message instanceof SIPMessage.IncomingResponse) {\n    var _iterator3 = _createForOfIteratorHelper(responses),\n        _step3;\n\n    try {\n      for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n        var _check = _step3.value;\n\n        if (_check() === false) {\n          return false;\n        }\n      }\n    } catch (err) {\n      _iterator3.e(err);\n    } finally {\n      _iterator3.f();\n    }\n  } // Everything is OK.\n\n\n  return true;\n};\n/*\n * Sanity Check for incoming Messages\n *\n * Requests:\n *  - _rfc3261_8_2_2_1_ Receive a Request with a non supported URI scheme\n *  - _rfc3261_16_3_4_ Receive a Request already sent by us\n *   Does not look at via sent-by but at jssip_id, which is inserted as\n *   a prefix in all initial requests generated by the ua\n *  - _rfc3261_18_3_request_ Body Content-Length\n *  - _rfc3261_8_2_2_2_ Merged Requests\n *\n * Responses:\n *  - _rfc3261_8_1_3_3_ Multiple Via headers\n *  - _rfc3261_18_3_response_ Body Content-Length\n *\n * All:\n *  - Minimum headers in a SIP message\n */\n// Sanity Check functions for requests.\n\n\nfunction rfc3261_8_2_2_1() {\n  if (message.s('to').uri.scheme !== 'sip') {\n    reply(416);\n    return false;\n  }\n}\n\nfunction rfc3261_16_3_4() {\n  if (!message.to_tag) {\n    if (message.call_id.substr(0, 5) === ua.configuration.jssip_id) {\n      reply(482);\n      return false;\n    }\n  }\n}\n\nfunction rfc3261_18_3_request() {\n  var len = Utils.str_utf8_length(message.body);\n  var contentLength = message.getHeader('content-length');\n\n  if (len < contentLength) {\n    reply(400);\n    return false;\n  }\n}\n\nfunction rfc3261_8_2_2_2() {\n  var fromTag = message.from_tag;\n  var call_id = message.call_id;\n  var cseq = message.cseq;\n  var tr; // Accept any in-dialog request.\n\n  if (message.to_tag) {\n    return;\n  } // INVITE request.\n\n\n  if (message.method === JsSIP_C.INVITE) {\n    // If the branch matches the key of any IST then assume it is a retransmission\n    // and ignore the INVITE.\n    // TODO: we should reply the last response.\n    if (ua._transactions.ist[message.via_branch]) {\n      return false;\n    } // Otherwise check whether it is a merged request.\n    else {\n        for (var transaction in ua._transactions.ist) {\n          if (Object.prototype.hasOwnProperty.call(ua._transactions.ist, transaction)) {\n            tr = ua._transactions.ist[transaction];\n\n            if (tr.request.from_tag === fromTag && tr.request.call_id === call_id && tr.request.cseq === cseq) {\n              reply(482);\n              return false;\n            }\n          }\n        }\n      }\n  } // Non INVITE request.\n  // If the branch matches the key of any NIST then assume it is a retransmission\n  // and ignore the request.\n  // TODO: we should reply the last response.\n  else if (ua._transactions.nist[message.via_branch]) {\n      return false;\n    } // Otherwise check whether it is a merged request.\n    else {\n        for (var _transaction in ua._transactions.nist) {\n          if (Object.prototype.hasOwnProperty.call(ua._transactions.nist, _transaction)) {\n            tr = ua._transactions.nist[_transaction];\n\n            if (tr.request.from_tag === fromTag && tr.request.call_id === call_id && tr.request.cseq === cseq) {\n              reply(482);\n              return false;\n            }\n          }\n        }\n      }\n} // Sanity Check functions for responses.\n\n\nfunction rfc3261_8_1_3_3() {\n  if (message.getHeaders('via').length > 1) {\n    logger.debug('more than one Via header field present in the response, dropping the response');\n    return false;\n  }\n}\n\nfunction rfc3261_18_3_response() {\n  var len = Utils.str_utf8_length(message.body),\n      contentLength = message.getHeader('content-length');\n\n  if (len < contentLength) {\n    logger.debug('message body length is lower than the value in Content-Length header field, dropping the response');\n    return false;\n  }\n} // Sanity Check functions for requests and responses.\n\n\nfunction minimumHeaders() {\n  var mandatoryHeaders = ['from', 'to', 'call_id', 'cseq', 'via'];\n\n  for (var _i = 0, _mandatoryHeaders = mandatoryHeaders; _i < _mandatoryHeaders.length; _i++) {\n    var header = _mandatoryHeaders[_i];\n\n    if (!message.hasHeader(header)) {\n      logger.debug(\"missing mandatory header field : \".concat(header, \", dropping the response\"));\n      return false;\n    }\n  }\n} // Reply.\n\n\nfunction reply(status_code) {\n  var vias = message.getHeaders('via');\n  var to;\n  var response = \"SIP/2.0 \".concat(status_code, \" \").concat(JsSIP_C.REASON_PHRASE[status_code], \"\\r\\n\");\n\n  var _iterator4 = _createForOfIteratorHelper(vias),\n      _step4;\n\n  try {\n    for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n      var via = _step4.value;\n      response += \"Via: \".concat(via, \"\\r\\n\");\n    }\n  } catch (err) {\n    _iterator4.e(err);\n  } finally {\n    _iterator4.f();\n  }\n\n  to = message.getHeader('To');\n\n  if (!message.to_tag) {\n    to += \";tag=\".concat(Utils.newTag());\n  }\n\n  response += \"To: \".concat(to, \"\\r\\n\");\n  response += \"From: \".concat(message.getHeader('From'), \"\\r\\n\");\n  response += \"Call-ID: \".concat(message.call_id, \"\\r\\n\");\n  response += \"CSeq: \".concat(message.cseq, \" \").concat(message.method, \"\\r\\n\");\n  response += '\\r\\n';\n  transport.send(response);\n}","map":{"version":3,"sources":["/Users/tuphan/Desktop/gcallstest/node_modules/jssip/lib-es5/sanityCheck.js"],"names":["_createForOfIteratorHelper","o","allowArrayLike","it","Symbol","iterator","Array","isArray","_unsupportedIterableToArray","length","i","F","s","n","done","value","e","_e","f","TypeError","normalCompletion","didErr","err","step","next","_e2","minLen","_arrayLikeToArray","Object","prototype","toString","call","slice","constructor","name","from","test","arr","len","arr2","Logger","require","JsSIP_C","SIPMessage","Utils","logger","all","minimumHeaders","requests","rfc3261_8_2_2_1","rfc3261_16_3_4","rfc3261_18_3_request","rfc3261_8_2_2_2","responses","rfc3261_8_1_3_3","rfc3261_18_3_response","message","ua","transport","module","exports","m","u","t","_iterator","_step","_check2","IncomingRequest","_iterator2","_step2","check","IncomingResponse","_iterator3","_step3","_check","uri","scheme","reply","to_tag","call_id","substr","configuration","jssip_id","str_utf8_length","body","contentLength","getHeader","fromTag","from_tag","cseq","tr","method","INVITE","_transactions","ist","via_branch","transaction","hasOwnProperty","request","nist","_transaction","getHeaders","debug","mandatoryHeaders","_i","_mandatoryHeaders","header","hasHeader","concat","status_code","vias","to","response","REASON_PHRASE","_iterator4","_step4","via","newTag","send"],"mappings":"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","sourcesContent":["\"use strict\";\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it[\"return\"] != null) it[\"return\"](); } finally { if (didErr) throw err; } } }; }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nvar Logger = require('./Logger');\n\nvar JsSIP_C = require('./Constants');\n\nvar SIPMessage = require('./SIPMessage');\n\nvar Utils = require('./Utils');\n\nvar logger = new Logger('sanityCheck'); // Checks for requests and responses.\n\nvar all = [minimumHeaders]; // Checks for requests.\n\nvar requests = [rfc3261_8_2_2_1, rfc3261_16_3_4, rfc3261_18_3_request, rfc3261_8_2_2_2]; // Checks for responses.\n\nvar responses = [rfc3261_8_1_3_3, rfc3261_18_3_response]; // local variables.\n\nvar message;\nvar ua;\nvar transport;\n\nmodule.exports = function (m, u, t) {\n  message = m;\n  ua = u;\n  transport = t;\n\n  var _iterator = _createForOfIteratorHelper(all),\n      _step;\n\n  try {\n    for (_iterator.s(); !(_step = _iterator.n()).done;) {\n      var _check2 = _step.value;\n\n      if (_check2() === false) {\n        return false;\n      }\n    }\n  } catch (err) {\n    _iterator.e(err);\n  } finally {\n    _iterator.f();\n  }\n\n  if (message instanceof SIPMessage.IncomingRequest) {\n    var _iterator2 = _createForOfIteratorHelper(requests),\n        _step2;\n\n    try {\n      for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n        var check = _step2.value;\n\n        if (check() === false) {\n          return false;\n        }\n      }\n    } catch (err) {\n      _iterator2.e(err);\n    } finally {\n      _iterator2.f();\n    }\n  } else if (message instanceof SIPMessage.IncomingResponse) {\n    var _iterator3 = _createForOfIteratorHelper(responses),\n        _step3;\n\n    try {\n      for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n        var _check = _step3.value;\n\n        if (_check() === false) {\n          return false;\n        }\n      }\n    } catch (err) {\n      _iterator3.e(err);\n    } finally {\n      _iterator3.f();\n    }\n  } // Everything is OK.\n\n\n  return true;\n};\n/*\n * Sanity Check for incoming Messages\n *\n * Requests:\n *  - _rfc3261_8_2_2_1_ Receive a Request with a non supported URI scheme\n *  - _rfc3261_16_3_4_ Receive a Request already sent by us\n *   Does not look at via sent-by but at jssip_id, which is inserted as\n *   a prefix in all initial requests generated by the ua\n *  - _rfc3261_18_3_request_ Body Content-Length\n *  - _rfc3261_8_2_2_2_ Merged Requests\n *\n * Responses:\n *  - _rfc3261_8_1_3_3_ Multiple Via headers\n *  - _rfc3261_18_3_response_ Body Content-Length\n *\n * All:\n *  - Minimum headers in a SIP message\n */\n// Sanity Check functions for requests.\n\n\nfunction rfc3261_8_2_2_1() {\n  if (message.s('to').uri.scheme !== 'sip') {\n    reply(416);\n    return false;\n  }\n}\n\nfunction rfc3261_16_3_4() {\n  if (!message.to_tag) {\n    if (message.call_id.substr(0, 5) === ua.configuration.jssip_id) {\n      reply(482);\n      return false;\n    }\n  }\n}\n\nfunction rfc3261_18_3_request() {\n  var len = Utils.str_utf8_length(message.body);\n  var contentLength = message.getHeader('content-length');\n\n  if (len < contentLength) {\n    reply(400);\n    return false;\n  }\n}\n\nfunction rfc3261_8_2_2_2() {\n  var fromTag = message.from_tag;\n  var call_id = message.call_id;\n  var cseq = message.cseq;\n  var tr; // Accept any in-dialog request.\n\n  if (message.to_tag) {\n    return;\n  } // INVITE request.\n\n\n  if (message.method === JsSIP_C.INVITE) {\n    // If the branch matches the key of any IST then assume it is a retransmission\n    // and ignore the INVITE.\n    // TODO: we should reply the last response.\n    if (ua._transactions.ist[message.via_branch]) {\n      return false;\n    } // Otherwise check whether it is a merged request.\n    else {\n        for (var transaction in ua._transactions.ist) {\n          if (Object.prototype.hasOwnProperty.call(ua._transactions.ist, transaction)) {\n            tr = ua._transactions.ist[transaction];\n\n            if (tr.request.from_tag === fromTag && tr.request.call_id === call_id && tr.request.cseq === cseq) {\n              reply(482);\n              return false;\n            }\n          }\n        }\n      }\n  } // Non INVITE request.\n  // If the branch matches the key of any NIST then assume it is a retransmission\n  // and ignore the request.\n  // TODO: we should reply the last response.\n  else if (ua._transactions.nist[message.via_branch]) {\n      return false;\n    } // Otherwise check whether it is a merged request.\n    else {\n        for (var _transaction in ua._transactions.nist) {\n          if (Object.prototype.hasOwnProperty.call(ua._transactions.nist, _transaction)) {\n            tr = ua._transactions.nist[_transaction];\n\n            if (tr.request.from_tag === fromTag && tr.request.call_id === call_id && tr.request.cseq === cseq) {\n              reply(482);\n              return false;\n            }\n          }\n        }\n      }\n} // Sanity Check functions for responses.\n\n\nfunction rfc3261_8_1_3_3() {\n  if (message.getHeaders('via').length > 1) {\n    logger.debug('more than one Via header field present in the response, dropping the response');\n    return false;\n  }\n}\n\nfunction rfc3261_18_3_response() {\n  var len = Utils.str_utf8_length(message.body),\n      contentLength = message.getHeader('content-length');\n\n  if (len < contentLength) {\n    logger.debug('message body length is lower than the value in Content-Length header field, dropping the response');\n    return false;\n  }\n} // Sanity Check functions for requests and responses.\n\n\nfunction minimumHeaders() {\n  var mandatoryHeaders = ['from', 'to', 'call_id', 'cseq', 'via'];\n\n  for (var _i = 0, _mandatoryHeaders = mandatoryHeaders; _i < _mandatoryHeaders.length; _i++) {\n    var header = _mandatoryHeaders[_i];\n\n    if (!message.hasHeader(header)) {\n      logger.debug(\"missing mandatory header field : \".concat(header, \", dropping the response\"));\n      return false;\n    }\n  }\n} // Reply.\n\n\nfunction reply(status_code) {\n  var vias = message.getHeaders('via');\n  var to;\n  var response = \"SIP/2.0 \".concat(status_code, \" \").concat(JsSIP_C.REASON_PHRASE[status_code], \"\\r\\n\");\n\n  var _iterator4 = _createForOfIteratorHelper(vias),\n      _step4;\n\n  try {\n    for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {\n      var via = _step4.value;\n      response += \"Via: \".concat(via, \"\\r\\n\");\n    }\n  } catch (err) {\n    _iterator4.e(err);\n  } finally {\n    _iterator4.f();\n  }\n\n  to = message.getHeader('To');\n\n  if (!message.to_tag) {\n    to += \";tag=\".concat(Utils.newTag());\n  }\n\n  response += \"To: \".concat(to, \"\\r\\n\");\n  response += \"From: \".concat(message.getHeader('From'), \"\\r\\n\");\n  response += \"Call-ID: \".concat(message.call_id, \"\\r\\n\");\n  response += \"CSeq: \".concat(message.cseq, \" \").concat(message.method, \"\\r\\n\");\n  response += '\\r\\n';\n  transport.send(response);\n}"]},"metadata":{},"sourceType":"script"}